---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Breadcrumb, PageNav } from '../../components/docs';
import { SectionRenderer } from '../../components/learn';

export async function getStaticPaths() {
  const entries = await getCollection('learn');
  return entries.map(entry => ({
    params: { slug: entry.id },
    props: { entry, allEntries: entries },
  }));
}

interface Props {
  entry: Awaited<ReturnType<typeof getCollection<'learn'>>>[number];
  allEntries: Awaited<ReturnType<typeof getCollection<'learn'>>>;
}

const { entry, allEntries } = Astro.props;
const { data } = entry;

// Build navigation - sort by order
const sorted = [...allEntries].sort((a, b) => a.data.order - b.data.order);
const currentIndex = sorted.findIndex(e => e.id === entry.id);
const prev = currentIndex > 0 ? sorted[currentIndex - 1] : null;
const next = currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;
---

<BaseLayout title={data.title} description={data.description}>
  <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-12">
    <Breadcrumb items={[
      { label: 'Learn', href: '/learn' },
      { label: data.title }
    ]} />

    <article>
      <header class="mb-10">
        <h1 class="text-4xl font-bold text-slate-900">{data.title}</h1>
        <p class="mt-4 text-lg text-slate-600 leading-relaxed">
          {data.description}
        </p>

        {data.tags && data.tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {data.tags.map(tag => (
              <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      <div class="prose prose-slate max-w-none">
        {data.sections.map(section => (
          <SectionRenderer section={section} />
        ))}
      </div>

      {data.related && data.related.length > 0 && (
        <aside class="mt-16 p-6 rounded-xl bg-slate-50 border border-slate-200">
          <h3 class="text-lg font-semibold text-slate-900 mb-4">Related Topics</h3>
          <div class="flex flex-wrap gap-3">
            {data.related.map(slug => {
              const related = allEntries.find(e => e.id === slug);
              if (!related) return null;
              return (
                <a
                  href={`/learn/${slug}`}
                  class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-700 hover:border-crystal-300 hover:text-crystal-600 transition-colors text-sm"
                >
                  {related.data.title}
                </a>
              );
            })}
          </div>
        </aside>
      )}
    </article>

    <PageNav
      prev={prev ? { label: prev.data.title, href: `/learn/${prev.id}` } : currentIndex === 0 ? { label: 'Back to Learn', href: '/learn' } : undefined}
      next={next ? { label: next.data.title, href: `/learn/${next.id}` } : undefined}
    />
  </div>
</BaseLayout>
