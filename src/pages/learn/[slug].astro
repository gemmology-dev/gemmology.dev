---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Breadcrumb, PageNav } from '../../components/docs';
import { SectionRenderer } from '../../components/learn';
import { Container, Card, Badge } from '../../components/ui-astro';

export async function getStaticPaths() {
  const entries = await getCollection('learn');
  return entries.map(entry => ({
    params: { slug: entry.id },
    props: { entry, allEntries: entries },
  }));
}

interface Props {
  entry: Awaited<ReturnType<typeof getCollection<'learn'>>>[number];
  allEntries: Awaited<ReturnType<typeof getCollection<'learn'>>>;
}

const { entry, allEntries } = Astro.props;
const { data } = entry;

// Build navigation - sort by order
const sorted = [...allEntries].sort((a, b) => a.data.order - b.data.order);
const currentIndex = sorted.findIndex(e => e.id === entry.id);
const prev = currentIndex > 0 ? sorted[currentIndex - 1] : null;
const next = currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;
---

<BaseLayout title={data.title} description={data.description}>
  <Container size="md" padding="md">
    <Breadcrumb items={[
      { label: 'Learn', href: '/learn' },
      { label: data.title }
    ]} />

    <article>
      <header class="mb-10">
        <h1 class="text-4xl font-bold text-slate-900">{data.title}</h1>
        <p class="mt-4 text-lg text-slate-600 leading-relaxed">
          {data.description}
        </p>

        {data.tags && data.tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {data.tags.map(tag => (
              <Badge variant="default">{tag}</Badge>
            ))}
          </div>
        )}
      </header>

      <div class="prose prose-slate prose-lg max-w-none
                  prose-headings:text-slate-900
                  prose-p:text-slate-600 prose-p:leading-relaxed
                  prose-strong:text-slate-900 prose-strong:font-semibold
                  prose-a:text-crystal-600 prose-a:no-underline hover:prose-a:underline">
        {data.sections.map(section => (
          <SectionRenderer section={section} />
        ))}
      </div>

      {data.related && data.related.length > 0 && (
        <Card padding="md" class="mt-16 bg-slate-50 border-slate-200">
          <h3 class="text-lg font-semibold text-slate-900 mb-4">Related Topics</h3>
          <div class="flex flex-wrap gap-3">
            {data.related.map(slug => {
              const related = allEntries.find(e => e.id === slug);
              if (!related) return null;
              return (
                <Card
                  href={`/learn/${slug}`}
                  hover
                  padding="none"
                  class="px-4 py-2 text-sm text-slate-700"
                >
                  {related.data.title}
                </Card>
              );
            })}
          </div>
        </Card>
      )}
    </article>

    <PageNav
      prev={prev ? { label: prev.data.title, href: `/learn/${prev.id}` } : currentIndex === 0 ? { label: 'Back to Learn', href: '/learn' } : undefined}
      next={next ? { label: next.data.title, href: `/learn/${next.id}` } : undefined}
    />
  </Container>
</BaseLayout>
