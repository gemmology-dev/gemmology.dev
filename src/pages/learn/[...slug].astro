---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Breadcrumb, PageNav } from '../../components/docs';
import { SectionRenderer } from '../../components/learn';
import { Container, Card, Badge } from '../../components/ui-astro';

export async function getStaticPaths() {
  const entries = await getCollection('learn');
  return entries.map(entry => ({
    params: { slug: entry.id },
    props: { entry, allEntries: entries },
  }));
}

interface Props {
  entry: Awaited<ReturnType<typeof getCollection<'learn'>>>[number];
  allEntries: Awaited<ReturnType<typeof getCollection<'learn'>>>;
}

const { entry, allEntries } = Astro.props;
const { data } = entry;

// Helper to format category/subcategory names for display
function formatCategoryName(name: string): string {
  return name
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

// Build navigation - sort by category, then subcategory, then order/difficulty
const categoryOrder = ['fundamentals', 'equipment', 'species', 'identification', 'phenomena', 'origin', 'market', 'care'];
const difficultyOrder = ['beginner', 'intermediate', 'advanced'];

const sorted = [...allEntries].sort((a, b) => {
  // First sort by category
  const aCatIndex = categoryOrder.indexOf(a.data.category);
  const bCatIndex = categoryOrder.indexOf(b.data.category);
  const aCat = aCatIndex !== -1 ? aCatIndex : categoryOrder.length;
  const bCat = bCatIndex !== -1 ? bCatIndex : categoryOrder.length;
  if (aCat !== bCat) return aCat - bCat;

  // Then group by subcategory (items without subcategory come first)
  const aSubcat = a.data.subcategory || '';
  const bSubcat = b.data.subcategory || '';
  if (aSubcat !== bSubcat) {
    if (!aSubcat) return -1;  // No subcategory comes first
    if (!bSubcat) return 1;
    return aSubcat.localeCompare(bSubcat);
  }

  // Within same subcategory, sort by order first
  if (a.data.order !== b.data.order) return a.data.order - b.data.order;

  // Then by difficulty as tiebreaker
  const aDiffIndex = difficultyOrder.indexOf(a.data.difficulty || 'intermediate');
  const bDiffIndex = difficultyOrder.indexOf(b.data.difficulty || 'intermediate');
  return aDiffIndex - bDiffIndex;
});

// For navigation: prefer staying within same subcategory
const currentIndex = sorted.findIndex(e => e.id === entry.id);
const currentSubcategory = data.subcategory;

// Find prev/next within subcategory context
let prev = null;
let next = null;

if (currentSubcategory) {
  // Filter to same subcategory for navigation
  const subcatEntries = sorted.filter(e => e.data.subcategory === currentSubcategory);
  const subcatIndex = subcatEntries.findIndex(e => e.id === entry.id);

  if (subcatIndex > 0) {
    prev = subcatEntries[subcatIndex - 1];
  } else if (subcatIndex === 0) {
    // At start of subcategory - link back to category or previous entry
    prev = currentIndex > 0 ? sorted[currentIndex - 1] : null;
  }

  if (subcatIndex < subcatEntries.length - 1) {
    next = subcatEntries[subcatIndex + 1];
  } else if (subcatIndex === subcatEntries.length - 1) {
    // At end of subcategory - link to next entry outside subcategory
    next = currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;
  }
} else {
  // No subcategory - use standard navigation
  prev = currentIndex > 0 ? sorted[currentIndex - 1] : null;
  next = currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;
}

// Build breadcrumb items
const breadcrumbItems: Array<{ label: string; href?: string }> = [
  { label: 'Learn', href: '/learn' },
  { label: formatCategoryName(data.category), href: `/learn#${data.category}` },
];

if (data.subcategory) {
  // Find the first/overview entry in this subcategory for the link
  const subcatOverview = sorted.find(e =>
    e.data.category === data.category &&
    e.data.subcategory === data.subcategory &&
    e.data.order === 1
  );
  breadcrumbItems.push({
    label: formatCategoryName(data.subcategory),
    href: subcatOverview ? `/learn/${subcatOverview.id}` : undefined,
  });
}

breadcrumbItems.push({ label: data.title });
---

<BaseLayout title={data.title} description={data.description}>
  <Container size="md" padding="md">
    <Breadcrumb items={breadcrumbItems} />

    <article>
      <header class="mb-10">
        <h1 class="text-4xl font-bold text-slate-900">{data.title}</h1>
        <p class="mt-4 text-lg text-slate-600 leading-relaxed">
          {data.description}
        </p>

        {data.tags && data.tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {data.tags.map(tag => (
              <Badge variant="default">{tag}</Badge>
            ))}
          </div>
        )}
      </header>

      <div class="prose prose-slate prose-lg max-w-none
                  prose-headings:text-slate-900
                  prose-p:text-slate-600 prose-p:leading-relaxed
                  prose-strong:text-slate-900 prose-strong:font-semibold
                  prose-a:text-crystal-600 prose-a:no-underline hover:prose-a:underline">
        {data.sections.map(section => (
          <SectionRenderer section={section} />
        ))}
      </div>

      {data.related && data.related.length > 0 && (
        <Card padding="md" class="mt-16 bg-slate-50 border-slate-200">
          <h3 class="text-lg font-semibold text-slate-900 mb-4">Related Topics</h3>
          <div class="flex flex-wrap gap-3">
            {data.related.map(slug => {
              const related = allEntries.find(e => e.id === slug);
              if (!related) return null;
              return (
                <Card
                  href={`/learn/${slug}`}
                  hover
                  padding="none"
                  class="px-4 py-2 text-sm text-slate-700"
                >
                  {related.data.title}
                </Card>
              );
            })}
          </div>
        </Card>
      )}
    </article>

    <PageNav
      prev={prev ? { label: prev.data.title, href: `/learn/${prev.id}` } : currentIndex === 0 ? { label: 'Back to Learn', href: '/learn' } : undefined}
      next={next ? { label: next.data.title, href: `/learn/${next.id}` } : undefined}
    />
  </Container>
</BaseLayout>
